version: 0.2
phases:
  pre_build:
    commands:
      - echo Logging in to Amazon ECR...
      # - echo $AWS_DEFAULT_REGION
      - aws ecr get-login-password --region ap-south-1 | docker login --username AWS --password-stdin 058264490987.dkr.ecr.ap-south-1.amazonaws.com/dockerimages
      - REPOSITORY_NAME="dockerimages"      
      - REPOSITORY_URI=058264490987.dkr.ecr.ap-south-1.amazonaws.com/$REPOSITORY_NAME
  build:
    commands:
      # Frontend
      - echo testing frontend application using rspec
      - path=`pwd`
      - cd $path/frontend
      - docker build -t $REPOSITORY_NAME:frontend .
      - docker tag $REPOSITORY_NAME:frontend $REPOSITORY_URI:frontend-${CODEBUILD_BUILD_NUMBER}
      - docker push $REPOSITORY_URI:frontend-${CODEBUILD_BUILD_NUMBER}

      - cd $path/backend
      - echo building backend - tagging and pushing docker image.
      - docker build -t $REPOSITORY_NAME:backend .
      - docker tag $REPOSITORY_NAME:backend $REPOSITORY_URI:backend-${CODEBUILD_BUILD_NUMBER}
      - docker push $REPOSITORY_URI:backend-${CODEBUILD_BUILD_NUMBER}
      # - docker tag $REPOSITORY_NAME:frontend $REPOSITORY_URI:frontend-${CODEBUILD_BUILD_NUMBER}
      # - docker push $REPOSITORY_URI:frontend-${CODEBUILD_BUILD_NUMBER}

#       # Backend
#       - echo building frontend - tagging and pushing docker image.
#       - docker build -t $REPOSITORY_NAME:app -f /Users/vedika/Documents/Home-lab/project/frontend/dockerfile .
#       - docker tag $REPOSITORY_NAME:app $REPOSITORY_URI:app-${CODEBUILD_BUILD_NUMBER}
#       - docker push $REPOSITORY_URI:app-${CODEBUILD_BUILD_NUMBER}
  
# artifacts:
#   files: imagedefinitions.json